<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•œê¸€ ì–´íœ˜ í•™ìŠµ - KOREAN STUDY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />
  <!-- ì£¼ì•„ì²´ í°íŠ¸ ì¶”ê°€ -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Jua&display=swap" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      color: #111827;
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 32px auto 48px;
      padding: 0 16px;
    }

    .main-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 20px;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .mode-tab {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      background: #eef1ff;
      color: #111827;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    /* ê¸°ë³¸ í™œì„± íƒ­ ìƒ‰: ë¸”ë£¨ */
    .mode-tab.active {
      background: #00AEEF;
      color: #ffffff;
      box-shadow: 0 12px 25px rgba(0, 174, 239, 0.35);
    }

    /* ëœ» ì°¾ê¸° / ë“£ê³  ì°¾ê¸° í™œì„± íƒ­: í•‘í¬ */
    .mode-tab.active[data-mode="meaning"],
    .mode-tab.active[data-mode="listening"] {
      background: #FF6FB5;
      color: #ffffff;
      box-shadow: 0 12px 25px rgba(255, 111, 181, 0.45);
    }

    .card {
      background: #ffffff;
      border-radius: 28px;
      padding: 40px 60px 32px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      min-height: 360px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .audio-badge {
      position: absolute;
      top: 18px;
      right: 26px;
      padding: 6px 14px;
      border-radius: 999px;
      background: #e5edff;
      font-size: 12px;
      color: #1d4ed8;
      display: none; /* ì§€ê¸ˆì€ ë±ƒì§€ ìˆ¨ê¹€ */
    }

    .center-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 12px;
      padding: 10px 8px;
      min-height: 260px;
    }

    /* í•œê¸€ ë‹¨ì–´ë¥¼ ë³´ì—¬ì¤„ ë•Œ ì‚¬ìš©í•  ìŠ¤íƒ€ì¼ */
    .word-big {
      font-size: 72px;
      font-weight: 800;
      color: #b91c1c;
      /* í‘œì œì–´ í•œê¸€ ë‹¨ì–´ ì£¼ì•„ì²´ ì ìš© */
      font-family: "Jua", "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    /* ì˜ì–´ ëœ»ì„ ë³´ì—¬ì¤„ ë•Œ ì‚¬ìš©í•  ìŠ¤íƒ€ì¼ */
    .meaning-big {
      font-size: 40px;
      font-weight: 700;
      color: #111827;
      /* ì˜ì–´ í°íŠ¸ëŠ” ê¸°ë³¸ ì‚°ì„¸ë¦¬í”„ */
      font-family: "Pretendard Variable", sans-serif; 
    }

    .example-target {
      font-size: 24px;
      font-weight: 600;
      color: #1f2937;
      margin-top: 18px;
      font-family: "Jua", sans-serif; /* ì˜ˆë¬¸ë„ í•œê¸€ ëŠë‚Œ ì‚´ë¦¬ê¸° */
    }

    .example-trans {
      font-size: 16px;
      color: #6b7280;
    }

    .question-title {
      font-size: 30px;
      font-weight: 800;
      margin-bottom: 8px;
      font-family: "Jua", sans-serif;
    }

    .choices-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px 24px;
      width: 100%;
      max-width: 620px;
      margin: 0 auto;
    }

    .choice-btn {
      width: 100%;
      min-height: 56px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .choice-btn:hover {
      background: #eef2ff;
    }

    .choice-btn.correct {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
      font-weight: 600;
    }

    .choice-btn.wrong {
      background: #fee2e2;
      border-color: #f97373;
      color: #b91c1c;
    }

    .sentence-target {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      font-family: "Jua", sans-serif;
    }

    .sentence-trans {
      font-size: 18px;
      color: #4b5563;
      margin-bottom: 18px;
    }

    .sentence-row {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
    }

    .sentence-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 18px;
      text-align: center;
    }

    /* í™•ì¸ ë²„íŠ¼: ë¯¼íŠ¸ */
    .check-btn {
      padding: 11px 24px;
      border-radius: 999px;
      background: #9AD7A0;
      border: none;
      color: #ffffff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
    }

    .hint-text,
    .result-text {
      min-height: 22px;
    }

    .hint-text {
      margin-top: 10px;
      font-size: 16px;
      color: #f97316;
    }

    .result-text {
      margin-top: 6px;
      font-size: 16px;
      color: #4b5563;
    }

    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      gap: 10px;
      font-size: 14px;
      color: #6b7280;
    }

    .bottom-right {
      display: flex;
      gap: 8px;
    }

    .nav-pill {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* ğŸ” ë‹¤ì‹œ ì‹œì‘ = ë¸”ë£¨ */
    .pill-reset {
      background: #00AEEF;
      color: #ffffff;
    }

    /* â¬…ï¸ ëŒì•„ê°€ê¸° = í•‘í¬ */
    .pill-back {
      background: #FF6FB5;
      color: #ffffff;
    }

    @media (max-width: 768px) {
      .card {
        padding: 28px 18px 24px;
      }
      .word-big { font-size: 54px; }
      .meaning-big { font-size: 30px; }
      .sentence-target { font-size: 24px; }
    }
  </style>
</head>
<body>
<div class="page">
  <h1 class="main-title" id="mainTitle">í•œê¸€ ì–´íœ˜ í•™ìŠµ</h1>

  <div class="top-bar">
    <button class="mode-tab active" data-mode="study">ğŸ“š í•™ìŠµ í•˜ê¸°</button>
    <button class="mode-tab" data-mode="meaning">âœ… ëœ» ì°¾ê¸°</button>
    <button class="mode-tab" data-mode="korean">ğŸ‡°ğŸ‡· í•œê¸€ ì°¾ê¸°</button>
    <button class="mode-tab" data-mode="listening">ğŸ§ ë“£ê³  ì°¾ê¸°</button>
    <button class="mode-tab" data-mode="sentence">âœï¸ ë¬¸ì¥ ë¹ˆì¹¸</button>
  </div>

  <div class="card">
    <div class="audio-badge" id="audioBadge"></div>
    <div class="center-area" id="centerArea"></div>

    <div class="bottom-bar">
      <div id="progressText">0 / 0</div>
      <div class="bottom-right">
        <button class="nav-pill pill-reset" id="modeResetBtn">ë‹¤ì‹œ ì‹œì‘</button>
        <button class="nav-pill pill-back" id="backToUnitsBtn">ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- ë‹¨ì–´ ë°ì´í„° (í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë‚´ë¶€ì— í¬í•¨ì‹œì¼°ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— words.jsë¥¼ ì´ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”) -->
<script>
    // ìƒ˜í”Œ ë°ì´í„°ì…ë‹ˆë‹¤. ê¸°ì¡´ words.js ëŒ€ì‹  ì´ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
    window.WORD_DB = {
        "1-1": [
            { word: "ì•ˆë…•í•˜ì„¸ìš”", meaning: "Hello", exampleKo: "ì•ˆë…•í•˜ì„¸ìš”, ì„ ìƒë‹˜.", exampleEn: "Hello, teacher." },
            { word: "ê°ì‚¬í•©ë‹ˆë‹¤", meaning: "Thank you", exampleKo: "ë„ì™€ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.", exampleEn: "Thank you for your help." },
            { word: "ì¹œêµ¬", meaning: "Friend", exampleKo: "ì €ëŠ” ì¢‹ì€ ì¹œêµ¬ê°€ ë§ì•„ìš”.", exampleEn: "I have many good friends." },
            { word: "ì‚¬ë‘", meaning: "Love", exampleKo: "ê°€ì¡±ì„ ì‚¬ë‘í•©ë‹ˆë‹¤.", exampleEn: "I love my family." },
            { word: "í•™êµ", meaning: "School", exampleKo: "í•™êµì— ê°‘ë‹ˆë‹¤.", exampleEn: "I go to school." },
            { word: "ì‚¬ê³¼", meaning: "Apple", exampleKo: "ë§›ìˆëŠ” ì‚¬ê³¼ë¥¼ ë¨¹ì–´ìš”.", exampleEn: "I eat a delicious apple." },
            { word: "ë¬¼", meaning: "Water", exampleKo: "ë¬¼ì„ ë§ˆì‹œê³  ì‹¶ì–´ìš”.", exampleEn: "I want to drink water." },
            { word: "ì±…", meaning: "Book", exampleKo: "ë„ì„œê´€ì—ì„œ ì±…ì„ ì½ì–´ìš”.", exampleEn: "I read a book at the library." },
            { word: "ì§‘", meaning: "House / Home", exampleKo: "ì§‘ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.", exampleEn: "I am going back home." },
            { word: "í•œêµ­", meaning: "Korea", exampleKo: "ì €ëŠ” í•œêµ­ì—ì„œ ì™”ì–´ìš”.", exampleEn: "I am from Korea." }
        ]
    };
</script>

<!-- ì›ë˜ words.jsê°€ ìˆë‹¤ë©´ ì•„ë˜ ì£¼ì„ì„ í’€ê³  ì‚¬ìš©í•˜ì„¸ìš” -->
<!-- <script src="words.js"></script> -->

<!-- Supabase JS (ê¸°ì¡´ ìœ ì§€) -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

<script>
  // ---------- Supabase ì„¤ì • (ê¸°ì¡´ ìœ ì§€) ----------
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentStudentLoginId = null;
  (function loadStudent() {
    try {
      const raw = localStorage.getItem("blossom_student");
      if (!raw) return;
      const s = JSON.parse(raw);
      currentStudentLoginId = s.login_id || s.id || null;
    } catch (e) {
      console.error("í•™ìƒ ì •ë³´ ì½ê¸° ì˜¤ë¥˜:", e);
    }
  })();

  // ---------- URL íŒŒë¼ë¯¸í„° & ë‹¨ì–´ ë°ì´í„° ----------
  const params = new URLSearchParams(window.location.search);
  let unitKey = params.get("unit") || "1-1";

  if (/^\d+$/.test(unitKey)) {
    unitKey = unitKey + "-1";
  }

  // WORD_DBê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ë¡œ ì´ˆê¸°í™”
  const WORD_DB = window.WORD_DB || {};
  const words = WORD_DB[unitKey] || [];
  const wordCount = words.length;

  const mainTitle = document.getElementById("mainTitle");
  mainTitle.textContent = `í•œê¸€ ì–´íœ˜ í•™ìŠµ ${unitKey}`;

  const centerArea = document.getElementById("centerArea");
  const audioBadge = document.getElementById("audioBadge");
  const progressText = document.getElementById("progressText");
  const modeTabs = document.querySelectorAll(".mode-tab");
  const modeResetBtn = document.getElementById("modeResetBtn");
  const backToUnitsBtn = document.getElementById("backToUnitsBtn");

  let currentMode = "study";
  let currentIndex = 0;

  // ìë™ ì§„í–‰ë˜ëŠ” ê°ê´€ì‹ ëª¨ë“œë“¤
  const AUTO_QUIZ_MODES = ["meaning", "korean", "listening"];

  let quizQueue = [];
  let quizPos = 0;
  let nextRoundQueue = [];
  let quizFinished = false;
  let answerTimer = null;

  let sentenceOrder = [];
  let sentencePos = 0;

  // ------------ ê³µí†µ ìœ í‹¸ ------------

  function setProgress(current, total) {
    progressText.textContent = `${current} / ${total}`;
  }

  function stopSpeech() {
    const synth = window.speechSynthesis;
    if (synth && (synth.speaking || synth.pending)) {
      synth.cancel();
    }
  }

  function shuffleArray(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function resetQuizFlow() {
    if (!AUTO_QUIZ_MODES.includes(currentMode) || !wordCount) {
      quizQueue = [];
      nextRoundQueue = [];
      quizPos = 0;
      quizFinished = false;
      return;
    }
    const base = [];
    for (let i = 0; i < wordCount; i++) base.push(i);
    quizQueue = shuffleArray(base);
    nextRoundQueue = [];
    quizPos = 0;
    quizFinished = false;
  }

  function resetSentenceFlow() {
    if (!wordCount) {
      sentenceOrder = [];
      sentencePos = 0;
      return;
    }
    const base = [];
    for (let i = 0; i < wordCount; i++) base.push(i);
    sentenceOrder = shuffleArray(base);
    sentencePos = 0;
  }

  async function saveVocabResultForCurrentMode() {
    if (!currentStudentLoginId) return;
    if (!wordCount) return;

    try {
      const { error } = await client.from("vocab_results").insert({
        student_login_id: currentStudentLoginId,
        unit: unitKey,
        mode: currentMode,
        correct_count: wordCount,
        total_count: wordCount,
        submitted_at: new Date().toISOString()
      });
      if (error) console.error("ì €ì¥ ì˜¤ë¥˜:", error);
    } catch (e) {
      console.error("ì €ì¥ ì˜ˆì™¸:", e);
    }
  }

  function showQuizFinished() {
    stopSpeech();
    audioBadge.style.display = "none";
    centerArea.innerHTML = `
      <div class="question-title">ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆì–´ìš”!</div>
      <div style="margin-top:10px;font-size:22px;color:#16a34a;font-weight:700;">
        ì°¸ ì˜í–ˆì–´ìš”! ğŸ‰
      </div>
      <div style="margin-top:12px;font-size:14px;color:#6b7280;">
        ë‹¤ì‹œ ì—°ìŠµí•˜ë ¤ë©´ "ë‹¤ì‹œ ì‹œì‘"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>
    `;
    setProgress(wordCount, wordCount);
    saveVocabResultForCurrentMode();
  }

  function goNextQuestion(wrongIndexOrNull) {
    if (!AUTO_QUIZ_MODES.includes(currentMode)) return;

    if (wrongIndexOrNull !== null && wrongIndexOrNull !== undefined) {
      nextRoundQueue.push(wrongIndexOrNull);
    }

    quizPos++;

    if (quizPos >= quizQueue.length) {
      if (nextRoundQueue.length > 0) {
        quizQueue = nextRoundQueue;
        nextRoundQueue = [];
        quizPos = 0;
        renderCurrent();
      } else {
        quizFinished = true;
        showQuizFinished();
      }
    } else {
      renderCurrent();
    }
  }

  // ------------ ë°œìŒ (í•œêµ­ì–´ TTS) ------------

  const STUDY_GAP_BETWEEN_READS = 1000;
  const STUDY_GAP_AFTER_SECOND  = 2600;

  function speakWordTwice(word, afterSecondDone) {
    const synth = window.speechSynthesis;
    if (!synth) {
      if (afterSecondDone) afterSecondDone();
      return;
    }
    synth.cancel();

    const u1 = new SpeechSynthesisUtterance(word);
    const u2 = new SpeechSynthesisUtterance(word);

    // ** ì¤‘ìš”: í•œêµ­ì–´ ì„¤ì • **
    u1.lang = "ko-KR";
    u2.lang = "ko-KR";
    u1.rate = 0.9;
    u2.rate = 0.9;

    // í•œêµ­ì–´ ìŒì„± ì°¾ê¸°
    const voices = synth.getVoices();
    const koreanVoice = voices.find(v => 
        v.lang.includes("ko") || v.name.includes("Korea") || v.name.includes("í•œêµ­")
    );
    
    if (koreanVoice) {
      u1.voice = koreanVoice;
      u2.voice = koreanVoice;
    }

    u1.onend = () => {
      setTimeout(() => synth.speak(u2), STUDY_GAP_BETWEEN_READS);
    };

    u2.onend = () => {
      if (afterSecondDone) {
        setTimeout(afterSecondDone, STUDY_GAP_AFTER_SECOND);
      }
    };

    synth.speak(u1);
  }

  // ------------ ëª¨ë“œ 1: í•™ìŠµ í•˜ê¸° (Study) ------------
  // í•œê¸€(í¬ê²Œ) -> ì˜ì–´ ëœ» -> í•œê¸€ ì˜ˆë¬¸ -> ì˜ì–´ ë²ˆì—­

  function renderStudy() {
    stopSpeech();
    if (answerTimer) {
      clearTimeout(answerTimer);
      answerTimer = null;
    }

    if (!words.length) {
      centerArea.textContent = "ë‹¨ì–´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      audioBadge.style.display = "none";
      setProgress(0, 0);
      return;
    }

    const item = words[currentIndex];
    audioBadge.style.display = "none";

    centerArea.innerHTML = `
      <div class="word-big">${item.word}</div>
      <div class="meaning-big">${item.meaning}</div>
      <div class="example-target">${item.exampleKo}</div>
      <div class="example-trans">${item.exampleEn}</div>
    `;
    setProgress(currentIndex + 1, wordCount);

    speakWordTwice(item.word, () => {
      if (currentMode !== "study") return;
      currentIndex = (currentIndex + 1) % wordCount;
      renderStudy();
    });
  }

  // ------------ ê°ê´€ì‹ ê³µí†µ ------------

  function makeChoices(correctIdx) {
    const indices = [...Array(wordCount).keys()];
    const others = indices.filter(i => i !== correctIdx);
    
    // ì˜¤ë‹µ ì…”í”Œ
    for (let i = others.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [others[i], others[j]] = [others[j], others[i]];
    }
    const pick = others.slice(0, 3);
    const all = [correctIdx, ...pick];
    
    // ì „ì²´ ë³´ê¸° ì…”í”Œ
    for (let i = all.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [all[i], all[j]] = [all[j], all[i]];
    }
    return all;
  }

  function prepareQuizQuestionBase() {
    stopSpeech();
    if (answerTimer) {
      clearTimeout(answerTimer);
      answerTimer = null;
    }

    if (!words.length) {
      centerArea.textContent = "ë‹¨ì–´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return false;
    }

    if (!AUTO_QUIZ_MODES.includes(currentMode)) return false;

    if (!quizQueue.length && !quizFinished) {
      resetQuizFlow();
    }

    if (quizFinished) {
      showQuizFinished();
      return false;
    }
    return true;
  }

  // ------------ ëª¨ë“œ 2: ëœ» ì°¾ê¸° (Meaning) ------------
  // í•œê¸€ ë‹¨ì–´ ë³´ì—¬ì¤Œ -> ì˜ì–´ ëœ» ê³ ë¥´ê¸°

  function renderMeaningQuiz() {
    if (!prepareQuizQuestionBase()) return;

    audioBadge.style.display = "none";
    const qIndex = quizQueue[quizPos];
    const item = words[qIndex];

    centerArea.innerHTML = `
      <div class="question-title" style="font-size: 50px; color: #b91c1c;">${item.word}</div>
      <div style="margin-bottom: 20px; color: #6b7280;">ëœ»ì„ ê³¨ë¼ë³´ì„¸ìš”</div>
    `;

    const grid = document.createElement("div");
    grid.className = "choices-grid";
    centerArea.appendChild(grid);
    centerArea.dataset.answered = "false";

    const choices = makeChoices(qIndex);
    choices.forEach(idx => {
      const choice = words[idx];
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = choice.meaning; // ì˜ì–´ ëœ»ì´ ë³´ê¸°
      btn.style.fontFamily = '"Pretendard Variable", sans-serif'; // ì˜ì–´ í°íŠ¸
      grid.appendChild(btn);

      btn.onclick = () => {
        handleQuizAnswer(qIndex, idx === qIndex, btn, grid, item.meaning);
      };
    });

    const baseNumber = Math.min(quizPos + 1, wordCount);
    setProgress(baseNumber, wordCount);

    answerTimer = setTimeout(() => {
      handleQuizAnswer(qIndex, false, null, grid, item.meaning);
    }, 7000);
  }

  // ------------ ëª¨ë“œ 3: í•œê¸€ ì°¾ê¸° (Korean) ------------
  // ì˜ì–´ ëœ» ë³´ì—¬ì¤Œ -> í•œê¸€ ë‹¨ì–´ ê³ ë¥´ê¸°

  function renderKoreanQuiz() {
    if (!prepareQuizQuestionBase()) return;

    audioBadge.style.display = "none";
    const qIndex = quizQueue[quizPos];
    const item = words[qIndex];

    centerArea.innerHTML = `
      <div class="question-title">${item.meaning}</div>
      <div style="margin-bottom: 20px; color: #6b7280;">ì•Œë§ì€ í•œê¸€ ë‹¨ì–´ë¥¼ ê³ ë¥´ì„¸ìš”</div>
    `;

    const grid = document.createElement("div");
    grid.className = "choices-grid";
    centerArea.appendChild(grid);
    centerArea.dataset.answered = "false";

    const choices = makeChoices(qIndex);
    choices.forEach(idx => {
      const choice = words[idx];
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = choice.word; // í•œê¸€ ë‹¨ì–´ê°€ ë³´ê¸°
      btn.style.fontFamily = '"Jua", sans-serif'; // í•œê¸€ í°íŠ¸
      btn.style.fontSize = "22px";
      grid.appendChild(btn);

      btn.onclick = () => {
        handleQuizAnswer(qIndex, idx === qIndex, btn, grid, item.word);
      };
    });

    const baseNumber = Math.min(quizPos + 1, wordCount);
    setProgress(baseNumber, wordCount);

    answerTimer = setTimeout(() => {
      handleQuizAnswer(qIndex, false, null, grid, item.word);
    }, 7000);
  }

  // ------------ ëª¨ë“œ 4: ë“£ê³  ì°¾ê¸° (Listening) ------------
  // í•œê¸€ ë°œìŒ ë“£ê¸° -> ì˜ì–´ ëœ» ê³ ë¥´ê¸°

  function renderListeningQuiz() {
    if (!prepareQuizQuestionBase()) return;

    const qIndex = quizQueue[quizPos];
    const item = words[qIndex];

    audioBadge.style.display = "none";

    centerArea.innerHTML = `
      <div class="question-title">ğŸ‘‚ ì˜ ë“£ê³  ëœ»ì„ ë§í˜€ë³´ì„¸ìš”</div>
      <button onclick="speakWordTwice('${item.word}')" style="margin: 10px 0 20px; padding: 10px 20px; border-radius: 20px; border:none; background: #e5edff; color: #1d4ed8; font-weight:bold; cursor:pointer;">ğŸ”Š ë‹¤ì‹œ ë“£ê¸°</button>
    `;

    const grid = document.createElement("div");
    grid.className = "choices-grid";
    centerArea.appendChild(grid);
    centerArea.dataset.answered = "false";

    const choices = makeChoices(qIndex);
    choices.forEach(idx => {
      const choice = words[idx];
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = choice.meaning; // ì˜ì–´ ëœ»ì´ ì •ë‹µ
      btn.style.fontFamily = '"Pretendard Variable", sans-serif';
      grid.appendChild(btn);

      btn.onclick = () => {
        handleQuizAnswer(qIndex, idx === qIndex, btn, grid, item.meaning);
      };
    });

    const baseNumber = Math.min(quizPos + 1, wordCount);
    setProgress(baseNumber, wordCount);

    speakWordTwice(item.word, null);

    answerTimer = setTimeout(() => {
      handleQuizAnswer(qIndex, false, null, grid, item.meaning);
    }, 7000);
  }

  // ------------ ì •ë‹µ ì²˜ë¦¬ (ê³µí†µ) ------------

  function handleQuizAnswer(qIndex, isCorrect, clickedBtn, grid, correctText) {
    if (!AUTO_QUIZ_MODES.includes(currentMode)) return;
    if (centerArea.dataset.answered === "true") return;
    centerArea.dataset.answered = "true";

    if (answerTimer) {
      clearTimeout(answerTimer);
      answerTimer = null;
    }

    const buttons = grid.querySelectorAll(".choice-btn");
    buttons.forEach(btn => {
      if (btn.textContent === correctText) {
        btn.classList.add("correct");
      }
    });

    if (!isCorrect && clickedBtn) {
      clickedBtn.classList.add("wrong");
    }

    setTimeout(() => {
      goNextQuestion(isCorrect ? null : qIndex);
    }, 1200); // 1.2ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œ
  }

  // ------------ ëª¨ë“œ 5: ë¬¸ì¥ ë¹ˆì¹¸ (Sentence) ------------
  // í•œê¸€ ì˜ˆë¬¸ì— ë¹ˆì¹¸ ëš«ê¸° -> í•œê¸€ ë‹¨ì–´ ì…ë ¥

  function renderSentenceQuiz() {
    stopSpeech();
    if (answerTimer) {
      clearTimeout(answerTimer);
      answerTimer = null;
    }
    audioBadge.style.display = "none";

    if (!words.length) {
      centerArea.textContent = "ë‹¨ì–´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      setProgress(0, 0);
      return;
    }

    if (!sentenceOrder.length) resetSentenceFlow();
    if (sentencePos >= wordCount) {
      showQuizFinished();
      return;
    }

    const wordIndex = sentenceOrder[sentencePos];
    const item = words[wordIndex];
    
    // í•œê¸€ ì˜ˆë¬¸ì—ì„œ í•´ë‹¹ ë‹¨ì–´ë¥¼ ____ë¡œ ë³€ê²½
    const blanked = item.exampleKo.replace(new RegExp(item.word, "g"), "____");

    centerArea.innerHTML = `
      <div class="sentence-target">${blanked}</div>
      <div class="sentence-trans">${item.exampleEn}</div>
    `;

    const row = document.createElement("div");
    row.className = "sentence-row";

    const input = document.createElement("input");
    input.className = "sentence-input";
    input.placeholder = "í•œê¸€ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”";
    input.autocomplete = "off";

    const checkBtn = document.createElement("button");
    checkBtn.className = "check-btn";
    checkBtn.textContent = "í™•ì¸";

    row.appendChild(input);
    row.appendChild(checkBtn);
    centerArea.appendChild(row);

    const hintArea = document.createElement("div");
    hintArea.className = "hint-text";
    centerArea.appendChild(hintArea);

    const resultArea = document.createElement("div");
    resultArea.className = "result-text";
    centerArea.appendChild(resultArea);

    setProgress(sentencePos + 1, wordCount);

    function checkAnswer() {
      const v = input.value.trim();
      const answer = item.word; // í•œê¸€ ë‹¨ì–´ê°€ ì •ë‹µ
      if (!v) return;

      if (v === answer) {
        input.style.background = "#f0fdf4";
        input.style.borderColor = "#22c55e";
        resultArea.textContent = "ì •ë‹µì´ì—ìš”! ğŸ‘";
        hintArea.textContent = "";
        setTimeout(() => {
          if (sentencePos + 1 < wordCount) {
            sentencePos += 1;
            renderSentenceQuiz();
          } else {
            sentencePos = wordCount;
            showQuizFinished();
          }
        }, 1000);
      } else {
        input.style.background = "#fef2f2";
        input.style.borderColor = "#f97373";
        const first = answer.charAt(0);
        hintArea.textContent = `íŒíŠ¸: "${first}" (ìœ¼)ë¡œ ì‹œì‘í•´ìš”.`;
        resultArea.textContent = "ë‹¤ì‹œ í•œ ë²ˆ ìƒê°í•´ ë³¼ê¹Œìš”?";
        input.value = "";
        input.focus();
      }
    }

    checkBtn.onclick = checkAnswer;

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        checkAnswer();
      }
    });

    input.focus();
  }

  // ------------ ëª¨ë“œ ì „í™˜ & ì´ˆê¸°í™” ------------

  function renderCurrent() {
    modeTabs.forEach(tab =>
      tab.classList.toggle("active", tab.dataset.mode === currentMode)
    );

    if (currentMode === "study") {
      renderStudy();
    } else if (currentMode === "meaning") {
      renderMeaningQuiz();
    } else if (currentMode === "korean") {
      renderKoreanQuiz();
    } else if (currentMode === "listening") {
      renderListeningQuiz();
    } else if (currentMode === "sentence") {
      renderSentenceQuiz();
    }
  }

  modeTabs.forEach(tab => {
    tab.onclick = () => {
      stopSpeech();
      if (answerTimer) clearTimeout(answerTimer);
      
      currentMode = tab.dataset.mode;
      currentIndex = 0;

      if (AUTO_QUIZ_MODES.includes(currentMode)) resetQuizFlow();
      if (currentMode === "sentence") resetSentenceFlow();

      renderCurrent();
    };
  });

  modeResetBtn.onclick = () => {
    stopSpeech();
    if (answerTimer) clearTimeout(answerTimer);
    currentIndex = 0;
    resetQuizFlow();
    resetSentenceFlow();
    renderCurrent();
  };

  backToUnitsBtn.onclick = () => {
    window.history.back();
  };

  // ìµœì´ˆ ì‹¤í–‰
  // ë¸Œë¼ìš°ì €ê°€ ìŒì„± ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” ë° ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì‹œ ëŒ€ê¸°
  if (window.speechSynthesis.onvoiceschanged !== undefined) {
    window.speechSynthesis.onvoiceschanged = () => {};
  }
  
  renderCurrent();

</script>
</body>
</html>