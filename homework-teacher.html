<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>온라인 숙제 만들기 - 블라썸잉글리쉬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    :root {
      --blue: #00AEEF;
      --mint: #9FE6B8;
      --pink: #FF6FB5;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 24px 0 40px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 10px;
    }

    .title-big {
      font-size: 28px;
      font-weight: 900;
    }

    .subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }

    .link-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: var(--blue); /* 메인으로 버튼 색 */
      color: #ffffff;
      white-space: nowrap;
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      padding: 18px 20px 20px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08);
      margin-bottom: 18px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      gap: 8px;
      font-size: 14px;
      color: #4b5563;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      background: #ffe4f6;      /* 연한 핑크 배경 */
      color: var(--pink);        /* 핑크 텍스트 */
      font-size: 12px;
      margin-left: 6px;
      font-weight: 600;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 4px;
      align-items: flex-end;
    }

    .field {
      min-width: 140px;
    }

    .field label {
      display: block;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 4px;
      text-align: center; /* 1~5 라벨 가운데 정렬 */
    }

    select,
    input[type="number"],
    input[type="text"],
    input[type="date"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #ffffff;
    }

    .wide-field {
      min-width: 260px;
    }

    .pill-group {
      display: inline-flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 3px;
      gap: 4px;
    }

    .pill-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: transparent;
      color: #4b5563;
      white-space: nowrap;
    }

    .pill-btn.active {
      background: var(--blue); /* 어휘/문장 pill 활성 색 */
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(0, 174, 239, 0.35);
    }

    .primary-btn {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font-size: 14px;
      cursor: pointer;
      background: #10b981; /* 숙제 등록은 기존처럼 초록 */
      color: #ffffff;
      white-space: nowrap;
    }

    .primary-btn[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: #6b7280;
    }

    .status.error {
      color: #b91c1c;
    }

    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .list-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .hw-list {
      font-size: 13px;
      color: #4b5563;
    }

    .hw-item {
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .hw-item:last-child {
      border-bottom: none;
    }

    .hw-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-right: 4px;
    }

    .hw-tag.vocab {
      background: #fee2e2;
      color: #b91c1c;
    }

    .hw-tag.sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    .print-controls {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .visually-hidden {
      visibility: hidden;
    }

    /* 문항 수 input 가운데 정렬 */
    #word-count-input {
      text-align: center;
    }

    /* 버튼별 색 지정 */
    #logout-btn {
      background: var(--pink);
      color: #ffffff;
    }

    #btn-print-note {
      background: var(--blue);  /* 단어 암기장 출력: 블루 */
      color: #ffffff;
    }

    #btn-print-test {
      background: var(--mint);  /* 단어 시험지 출력: 민트 */
      color: #ffffff;
    }

    @media (max-width: 768px) {
      .top-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .form-row {
        flex-direction: column;
        align-items: stretch;
      }

      .print-controls {
        flex-direction: column;
        align-items: flex-start;
      }

      .wide-field {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="top-row">
    <div>
      <div class="title-big">온라인 숙제 만들기</div>
      <div class="subtitle">
        반을 선택하고 어휘/문장 숙제를 등록하면, 나중에 학생 진도와 연결해서 볼 수 있어요.
      </div>
    </div>
    <button class="link-btn" onclick="window.location.href='index.html'">
      ← 메인으로
    </button>
  </div>

  <!-- 1. 숙제 등록 카드 -->
  <div class="card">
    <div class="info-row">
      <div>
        로그인 계정:
        <span id="teacher-email">확인 중…</span>
        <span class="badge">선생님 전용</span>
      </div>
      <button class="link-btn" id="logout-btn">로그아웃</button>
    </div>

    <div class="form-row">
      <div class="field" style="min-width:180px;">
        <label>반 선택</label>
        <select id="class-select">
          <option value="">반을 선택하세요</option>
        </select>
      </div>

      <div class="field" style="min-width:160px;">
        <label>숙제 종류</label>
        <div class="pill-group">
          <button type="button" class="pill-btn active" id="type-vocab">어휘</button>
          <button type="button" class="pill-btn" id="type-sentence">문장</button>
        </div>
      </div>

      <div class="field wide-field">
        <label>학습 세트 (단계-세트)</label>
        <input id="set-input" type="text" placeholder="예: 1-1 또는 1-1, 1-2, 1-3" />
      </div>

      <div class="field" style="max-width:170px;">
        <label>마감일</label>
        <input id="due-input" type="date" />
      </div>

      <div class="field" style="min-width:120px;">
        <label class="visually-hidden">숙제 등록</label>
        <button class="primary-btn" id="save-btn">숙제 등록</button>
      </div>
    </div>

    <div class="hint">
      같은 단계만 여러 개 입력 가능 (예: 1-1, 1-2, 1-3)
    </div>

    <div id="status-msg" class="status"></div>
  </div>

  <!-- 2. 단어 시험지 / 암기장 출력 카드 -->
  <div class="card">
    <div class="list-title">단어 시험지 / 암기장 출력</div>

    <div id="print-status" class="status" style="margin-top:6px;">
      선택된 반: - / 숙제 종류: 어휘 / 세트 번호: -
    </div>

    <div class="print-controls">
      <button class="primary-btn" id="btn-print-note" style="min-width:180px;">
        단어 암기장 출력
      </button>

      <button class="primary-btn" id="btn-print-test" style="min-width:160px;">
        단어 시험지 출력
      </button>

      <div class="field wide-field">
        <label>문항 수</label>
        <input
          type="number"
          min="1"
          step="1"
          id="word-count-input"
          placeholder="예: 20"
        />
      </div>
    </div>
  </div>

  <!-- 3. 최근 숙제 카드 -->
  <div class="card">
    <div class="list-title">선택한 반의 최근 숙제</div>
    <div class="hint">어휘/문장 숙제를 등록하면 여기에서 바로 확인할 수 있어요.</div>
    <div id="hw-list" class="hw-list" style="margin-top:8px;">
      아직 숙제가 없어요. 반을 선택해 주세요.
    </div>
  </div>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const teacherEmailEl   = document.getElementById("teacher-email");
  const logoutBtn        = document.getElementById("logout-btn");
  const classSelect      = document.getElementById("class-select");
  const typeVocabBtn     = document.getElementById("type-vocab");
  const typeSentenceBtn  = document.getElementById("type-sentence");
  const setInput         = document.getElementById("set-input");
  const dueInput         = document.getElementById("due-input");
  const saveBtn          = document.getElementById("save-btn");
  const statusMsgEl      = document.getElementById("status-msg");
  const hwListEl         = document.getElementById("hw-list");

  const printStatusEl    = document.getElementById("print-status");
  const btnPrintTest     = document.getElementById("btn-print-test");
  const btnPrintNote     = document.getElementById("btn-print-note");
  const wordCountInput   = document.getElementById("word-count-input");

  let currentType = "vocab";

  function setStatus(msg, type = "") {
    statusMsgEl.textContent = msg || "";
    statusMsgEl.className = "status" + (type ? " " + type : "");
  }

  function setPrintStatus() {
    const classText =
      classSelect.options[classSelect.selectedIndex]?.text || "-";
    const setsText = setInput.value.trim() || "-";
    const typeText = currentType === "vocab" ? "어휘" : "문장";

    printStatusEl.textContent =
      `선택된 반: ${classText} / 숙제 종류: ${typeText} / 세트 번호: ${setsText}`;
  }

  async function checkTeacher() {
    const { data, error } = await client.auth.getUser();
    if (error || !data.user) {
      alert("선생님 계정으로 다시 로그인해 주세요.");
      window.location.href = "login.html";
      return;
    }
    teacherEmailEl.textContent = data.user.email || "(이메일 없음)";
  }

  logoutBtn.onclick = async () => {
    await client.auth.signOut();
    window.location.href = "login.html";
  };

  async function loadClasses() {
    const { data, error } = await client
      .from("classes")
      .select("id, name")
      .order("name", { ascending: true });

    if (error) {
      console.error("반 목록 오류:", error);
      return;
    }

    classSelect.innerHTML =
      '<option value="">반을 선택하세요</option>';

    (data || []).forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      classSelect.appendChild(opt);
    });
  }

  function parseLevelAndSets(setStr) {
    const parts = setStr
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    if (parts.length === 0) return null;

    const first = parts[0].split("-");
    if (first.length !== 2) return null;
    const level = Number(first[0]);
    if (!level) return null;

    const setNums = [];
    for (const p of parts) {
      const [lvStr, setStr2] = p.split("-");
      const lv = Number(lvStr);
      const sn = Number(setStr2);
      if (!lv || !sn || lv !== level) return null;
      setNums.push(sn);
    }
    return { level, sets: setNums, raw: parts.join(", ") };
  }

  async function saveHomework() {
    const classId = classSelect.value;
    const rawSet  = setInput.value.trim();
    const due     = dueInput.value;

    if (!classId) {
      setStatus("반을 먼저 선택해 주세요.", "error");
      return;
    }
    if (!rawSet) {
      setStatus("학습 세트를 입력해 주세요. (예: 1-1 또는 1-1, 1-2)", "error");
      return;
    }

    const parsed = parseLevelAndSets(rawSet);
       if (!parsed) {
      setStatus("세트 형식이 올바르지 않아요. 예: 1-1, 1-2, 1-3", "error");
      return;
    }

    if (!due) {
      setStatus("마감일을 선택해 주세요.", "error");
      return;
    }

    setStatus("숙제를 저장 중입니다…");

    const tableName =
      currentType === "vocab" ? "vocab_homework" : "sentence_homework";

    const { error } = await client.from(tableName).insert({
      class_id: classId,
      level: parsed.level,
      set_numbers: parsed.raw,
      due_date: due
    });

    if (error) {
      console.error("숙제 저장 오류:", error);
      setStatus("숙제를 저장하는 중 오류가 발생했어요.", "error");
      return;
    }

    setStatus("숙제가 등록되었어요!", "success");
    await loadHomeworkList();
  }

  saveBtn.onclick = saveHomework;

  function setType(nextType) {
    currentType = nextType;
    if (nextType === "vocab") {
      typeVocabBtn.classList.add("active");
      typeSentenceBtn.classList.remove("active");
    } else {
      typeSentenceBtn.classList.add("active");
      typeVocabBtn.classList.remove("active");
    }
    setPrintStatus();
    loadHomeworkList();
  }

  typeVocabBtn.onclick = () => setType("vocab");
  typeSentenceBtn.onclick = () => setType("sentence");

  async function loadHomeworkList() {
    const classId = classSelect.value;
    if (!classId) {
      hwListEl.textContent = "아직 숙제가 없어요. 반을 선택해 주세요.";
      return;
    }

    const tableName =
      currentType === "vocab" ? "vocab_homework" : "sentence_homework";

    const { data, error } = await client
      .from(tableName)
      .select("id, level, set_numbers, due_date, created_at")
      .eq("class_id", classId)
      .order("created_at", { ascending: false })
      .limit(10);

    if (error) {
      console.error("숙제 목록 오류:", error);
      hwListEl.textContent = "숙제 목록을 불러오는 중 오류가 발생했어요.";
      return;
    }

    if (!data || data.length === 0) {
      hwListEl.textContent = "이 반에는 아직 등록된 숙제가 없어요.";
      return;
    }

    hwListEl.innerHTML = "";
    data.forEach(row => {
      const div = document.createElement("div");
      div.className = "hw-item";

      const tagSpan = document.createElement("span");
      tagSpan.className =
        "hw-tag " + (currentType === "vocab" ? "vocab" : "sentence");
      tagSpan.textContent =
        currentType === "vocab" ? "어휘" : "문장";

      const mainSpan = document.createElement("span");
      mainSpan.textContent =
        ` 레벨 ${row.level} / 세트: ${row.set_numbers} / 마감일: ${row.due_date || "-"}`;

      div.appendChild(tagSpan);
      div.appendChild(mainSpan);
      hwListEl.appendChild(div);
    });
  }

  classSelect.onchange = () => {
    setPrintStatus();
    loadHomeworkList();
  };
  setInput.oninput = setPrintStatus;

  function openPrintWindow(kind) {
    const rawSet = setInput.value.trim();
    const parsed = parseLevelAndSets(rawSet);

    if (!parsed) {
      alert("세트 번호를 먼저 올바르게 입력해 주세요. (예: 1-1, 1-2, 1-3)");
      return;
    }

    const level = parsed.level;
    const setsArray = parsed.sets;
    const sets = setsArray.join(",");

    if (kind === "note") {
      if (setsArray.length !== 1) {
        alert("단어 암기장은 한 세트만 출력할 수 있어요. 예: 1-1");
        return;
      }
      const unit = `${level}-${setsArray[0]}`;
      window.open(
        `print-vocab-note.html?unit=${encodeURIComponent(unit)}`,
        "_blank"
      );
    } else {
      let countParam = "";
      const rawCount = wordCountInput.value.trim();
      if (rawCount) {
        const n = Number(rawCount);
        if (!n || n <= 0) {
          alert("문항 수는 1 이상의 숫자로 입력해 주세요.");
          return;
        }
        countParam = `&count=${encodeURIComponent(n)}`;
      }
      window.open(
        `print-vocab-test.html?level=${level}&sets=${encodeURIComponent(sets)}${countParam}`,
        "_blank"
      );
    }
  }

  btnPrintNote.onclick = () => openPrintWindow("note");
  btnPrintTest.onclick = () => openPrintWindow("test");

  (async function init() {
    await checkTeacher();
    await loadClasses();
    setType("vocab");
    setPrintStatus();
  })();
</script>
</body>
</html>
