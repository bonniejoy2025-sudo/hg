<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìƒ íšŒì›ê°€ì… - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      min-height: 100vh;
      padding: 40px 0 60px;
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .card {
      background: #ffffff;
      border-radius: 32px;
      padding: 40px 40px 32px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.12);
    }

    .title {
      font-size: 30px;
      font-weight: 900;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 26px;
    }

    .form-row {
      margin-bottom: 18px;
    }

    .label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #111827;
    }

    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
      background: #f9fafb;
    }

    .input:focus {
      border-color: #2563eb;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .btn-primary {
      width: 100%;
      margin-top: 10px;
      padding: 13px 18px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 14px 35px rgba(37, 99, 235, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .status {
      margin-top: 14px;
      font-size: 13px;
      color: #6b7280;
    }

    .status.error {
      color: #b91c1c;
    }

    .status.success {
      color: #16a34a;
    }

    .bottom-link {
      margin-top: 20px;
      font-size: 13px;
      color: #4b5563;
      text-align: center;
    }

    .bottom-link a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }

    .back-link {
      margin-top: 8px;
      font-size: 13px;
      text-align: center;
    }

    .back-link a {
      color: #6b7280;
      text-decoration: none;
    }

    @media (max-width: 640px) {
      .card {
        padding: 30px 20px 24px;
        border-radius: 26px;
      }
      .title {
        font-size: 26px;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="card">
    <div class="title">í•™ìƒ íšŒì›ê°€ì…</div>
    <div class="subtitle">ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ì–´+ìˆ«ì 7ì ì´ìƒìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.</div>

    <div class="form-row">
      <div class="label">í•™ìƒ ì´ë¦„</div>
      <input id="nameInput" class="input" placeholder="ì˜ˆ: ê¹€ë¸”ë¼ì¸" />
    </div>

    <div class="form-row">
      <div class="label">í•™ìƒ ì•„ì´ë””</div>
      <input id="idInput" class="input" placeholder="ì˜ˆ: blossom01" />
      <div class="hint">ì˜ì–´+ìˆ«ì ì¡°í•© 7ì ì´ìƒ (ì˜ˆ: blossom01)</div>
    </div>

    <div class="form-row">
      <div class="label">ë¹„ë°€ë²ˆí˜¸</div>
      <input id="pwInput" class="input" type="password" placeholder="ì˜ì–´+ìˆ«ì 7ì ì´ìƒ" />
    </div>

    <div class="form-row">
      <div class="label">ë¶€ëª¨ë‹˜ ì „í™”ë²ˆí˜¸</div>
      <input id="parentInput" class="input" placeholder="ì˜ˆ: 01012345678" />
    </div>

    <button id="submitBtn" class="btn-primary">íšŒì›ê°€ì… ì™„ë£Œ</button>

    <div id="statusText" class="status"></div>

    <div class="bottom-link">
      ì´ë¯¸ ì•„ì´ë””ê°€ ìˆë‚˜ìš”?
      <a href="login.html">ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</a>
    </div>
    <div class="back-link">
      <a href="index.html">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </div>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // âœ… Supabase ì„¤ì • (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ)
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const nameInput   = document.getElementById("nameInput");
  const idInput     = document.getElementById("idInput");
  const pwInput     = document.getElementById("pwInput");
  const parentInput = document.getElementById("parentInput");
  const submitBtn   = document.getElementById("submitBtn");
  const statusText  = document.getElementById("statusText");

  function setStatus(msg, type) {
    statusText.textContent = msg || "";
    statusText.classList.remove("error", "success");
    if (type) statusText.classList.add(type);
  }

  // ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ê·œì¹™: ì˜ì–´+ìˆ«ì 7ì ì´ìƒ
  const idPwRegex = /^[A-Za-z0-9]{7,}$/;

  submitBtn.onclick = async () => {
    const name   = nameInput.value.trim();
    const sid    = idInput.value.trim();
    const pw     = pwInput.value.trim();
    const parent = parentInput.value.trim();

    // ğŸ” ê°„ë‹¨í•œ ì…ë ¥ ê²€ì¦
    if (!name) {
      setStatus("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
      nameInput.focus();
      return;
    }
    if (!idPwRegex.test(sid)) {
      setStatus("ì•„ì´ë””ëŠ” ì˜ì–´+ìˆ«ì 7ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
      idInput.focus();
      return;
    }
    if (!idPwRegex.test(pw)) {
      setStatus("ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ì–´+ìˆ«ì 7ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
      pwInput.focus();
      return;
    }
    if (!parent) {
      setStatus("ë¶€ëª¨ë‹˜ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
      parentInput.focus();
      return;
    }

    submitBtn.disabled = true;
    setStatus("íšŒì›ê°€ì…ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦");

    try {
      // ì´ë¯¸ ê°™ì€ ì•„ì´ë””ê°€ ìˆëŠ”ì§€ í•œë²ˆ í™•ì¸ (ì„ íƒ)
      const { data: existing, error: checkError } = await client
        .from("students")
        .select("id")
        .eq("student_id", sid)
        .maybeSingle();

      if (checkError) {
        console.log("checkError:", checkError);
      }

      if (existing) {
        setStatus("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
        submitBtn.disabled = false;
        return;
      }

      // âœ… students í…Œì´ë¸”ì— ìƒˆ í•™ìƒ ì¶”ê°€
      const { error } = await client.from("students").insert({
        student_id: sid,       // ë¡œê·¸ì¸ìš© ì•„ì´ë””
        name: name,
        password: pw,          // (ì§€ê¸ˆì€ ì—°ìŠµìš©ìœ¼ë¡œ í‰ë¬¸ ì €ì¥)
        parent_phone: parent
      });

      if (error) {
        console.error("insert error:", error);
        // unique ì œì•½ ìœ„ë°˜(ì•„ì´ë”” ì¤‘ë³µ)ì¼ ìˆ˜ ìˆìŒ
        if (error.code === "23505") {
          setStatus("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
        } else {
          setStatus("íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "error");
        }
        submitBtn.disabled = false;
        return;
      }

      // localStorageì— ê°„ë‹¨íˆ ì €ì¥ (ë‚˜ì¤‘ì— ìë™ ë¡œê·¸ì¸ ë“±ì— ì‚¬ìš© ê°€ëŠ¥)
      const studentInfo = {
        login_id: sid,
        name: name,
        parent_phone: parent
      };
      try {
        localStorage.setItem("blossom_student", JSON.stringify(studentInfo));
      } catch (e) {
        console.log("localStorage ì˜¤ë¥˜:", e);
      }

      setStatus("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë¡œê·¸ì¸ í•  ìˆ˜ ìˆì–´ìš”.", "success");

      // 1.5ì´ˆ ë’¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
      setTimeout(() => {
        window.location.href = "login.html";
      }, 1500);

    } catch (e) {
      console.error("unexpected error:", e);
      setStatus("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
      submitBtn.disabled = false;
    }
  };
</script>
</body>
</html>